name: Publish to gh-pages branch with archives

on: 
  push:
    branches: [ nomaster ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
        submodules: 'true'

    - name: create worktree under _site
      run: git worktree add -B gh-pages _site origin/gh-pages

    - name: Build only 🔧 
      uses: actions/jekyll-build-pages@v1 # Use official action

    - name: Checkout 2021 archive branch 🛎️
      uses: actions/checkout@v3
      with:
        ref: gh-pages-stars2021
        path: _site/archive-stars2021
        submodules: 'true'

    - name: Remove archive git repo ❌
      run: rm -rf _site/archive-stars2021/.git

    - name: Checkout 2022 archive branch 🛎️
      uses: actions/checkout@v3
      with:
        ref: gh-pages-stars2022
        path: _site/archive-stars2022
        submodules: 'true'

    - name: Remove archive git repo ❌
      run: rm -rf _site/archive-stars2022/.git

    - name: Push to gh-pages branch 🚀
      run: |
        echo -e "\033[0;32mDeploying updates to GitHub...\033[0m"
        git config user.email "cengique@users.noreply.github.com"
        git config user.name "cengique-gh-bot"
        cd _site
        git add --all && git commit -m "Publishing to gh-pages"
        git push origin gh-pages
